# РАЗРАБОТКА СИСТЕМЫ МОНИТОРИНГА И ОПТИМИЗАЦИИ ИНВЕСТИЦИОННОГО ПОРТФЕЛЯ

<!-- Здесь можно разместить логотип проекта или гифку-демонстрацию -->

**Кратко о проекте (TL;DR):** Это интеллектуальная система для управления криптовалютным портфелем. Она собирает рыночные данные и новости, прогнозирует цены (CatBoost), анализирует новостной фон (NLP, Llama3) и дает рекомендации по ребалансировке портфеля с помощью моделей глубокого обучения с подкреплением (DRL). Всё это управляется через MLOps платформу ClearML и представлено в удобном веб-интерфейсе на Streamlit.

[![Статус сборки](https://img.shields.io/badge/build-passing-brightgreen?style=for-the-badge)](https://github.com/USERNAME/REPOSITORY/actions) [![Лицензия: MIT](https://img.shields.io/badge/License-MIT-yellow.svg?style=for-the-badge)](https://opensource.org/licenses/MIT) [![Python_Version](https://img.shields.io/badge/python-3.10+-blue.svg?style=for-the-badge)](https://www.python.org/downloads/)

**Автор:** Асташов Игорь Владиславович  
**Научный руководитель:** к.ф-м н., доцент Елена Олеговна Кантонистова  
**Консультант:** Мурат Анзорович Хажгериев

<!-- IDEAS FOR VISUALS: Здесь можно разместить ссылку на короткое демо-видео (YouTube, Vimeo) -->
<!-- ## Демонстрационное видео
[Ссылка на видео-демонстрацию работы системы](URL_К_ВИДЕО) -->

## Быстрый старт (Как запускать)

Для запуска проекта рекомендуется использовать Docker Compose, что упрощает настройку всех сервисов.

**Предварительные требования:**
*   Установленный [Docker](https://www.docker.com/get-started) и Docker Compose.
*   [Poetry](https://python-poetry.org/docs/#installation) (для управления зависимостями, если планируется локальная разработка без Docker).
*   Аккаунт [ClearML](https://clear.ml/) и настроенные учетные данные (см. ниже).
*   Python 3.10+.

**Шаги для запуска:**

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/USERNAME/REPOSITORY.git
    cd REPOSITORY
    ```
2.  **Настройте переменные окружения:**
    *   Создайте файл `.env` из примера `.env_sample`. Заполните его вашими данными (ключи API для Binance, Alpha Vantage, параметры базы данных и т.д.).
        ```bash
        cp .env_sample .env
        # Отредактируйте .env
        ```
    *   Настройте секреты для Streamlit: создайте файл `.streamlit/secrets.toml` из `.streamlit/secrets_sample.toml` и укажите там необходимые ключи (например, для Binance API, если он используется напрямую из Streamlit).
        ```bash
        cp .streamlit/secrets_sample.toml .streamlit/secrets.toml
        # Отредактируйте .streamlit/secrets.toml
        ```
    *   **Настройка ClearML:** Убедитесь, что у вас настроены учетные данные ClearML. Обычно это делается командой `clearml-init` в терминале, после чего создается файл `clearml.conf`. Для Docker-окружения может потребоваться пробросить этот файл или переменные окружения `CLEARML_API_ACCESS_KEY`, `CLEARML_API_SECRET_KEY`, `CLEARML_API_HOST` в соответствующие сервисы через `docker-compose.yml` или `.env` файл.

3.  **Сборка и запуск Docker контейнеров:**
    ```bash
    docker-compose up --build -d
    ```
    Эта команда соберет образы (если их нет) и запустит все сервисы в фоновом режиме (`-d`).

4.  **Доступ к приложению:**
    *   **Streamlit Frontend:** Откройте в браузере `http://localhost:8501` (или другой порт, указанный в `docker-compose.yml`).
    *   **FastAPI Backend Docs:** Документация API (Swagger UI) будет доступна по адресу `http://localhost:8000/docs`.
    *   **ClearML UI:** Если вы развернули ClearML локально или используете облачную версию, доступ к интерфейсу ClearML будет по соответствующему адресу.

5.  **Остановка сервисов:**
    ```bash
    docker-compose down
    ```

## Обзор интерфейса (Вкладки Streamlit)

<!-- IDEAS FOR VISUALS: Скриншот главной страницы/дашборда -->

После запуска Streamlit-приложения вы увидите несколько основных разделов (вкладок):

*   **Главная / Дашборд:** Обзор текущего состояния портфеля, ключевые метрики, последние рекомендации.
*   **Мой Портфель / Транзакции:** Просмотр активов, добавление/удаление транзакций, история операций.
    <!-- IDEAS FOR VISUALS: Скриншот страницы управления транзакциями -->
*   **Рекомендации / Оптимизация:** Запрос и получение рекомендаций по ребалансировке портфеля с выбором DRL-модели.
    <!-- IDEAS FOR VISUALS: Скриншот страницы с результатами рекомендаций -->
*   **Анализ Новостей / FinRobot:** Анализ новостного фона по выбранным активам, оценка сентимента и чат с AI-агентом Llama3 для консультаций.
    <!-- IDEAS FOR VISUALS: Скриншот интерфейса анализа новостей и чата с AI-агентом -->
*   **Анализ Эффективности / Бэктестинг:** Запуск бэктестинга различных стратегий (DRL, Марковиц и др.) на исторических данных, сравнение их производительности.
    <!-- IDEAS FOR VISUALS: Скриншот страницы с результатами бэктестинга -->
*   **(Опционально) Управление Моделями:** Интерфейс для запуска обучения моделей через ClearML (может быть скрыт для обычных пользователей).

## 1. Обзор проекта

Данная работа посвящена разработке и исследованию системы мониторинга и оптимизации инвестиционного портфеля. Цель проекта - создание полнофункциональной системы, обеспечивающей автоматизированный сбор и обработку рыночных данных, анализ новостного фона, прогнозирование стоимости активов и формирование персонализированных рекомендаций по ребалансировке портфеля. Система использует современные методы машинного обучения (включая DRL и ансамблевые модели) и MLOps практики с применением платформы ClearML для масштабируемости, надежности и автоматизации жизненного цикла ML-моделей.

## 2. Ключевые возможности

*   **Сбор и управление данными:**
    *   Автоматический сбор исторических и текущих рыночных данных (OHLCV) для криптовалют через Binance API.
    *   Сбор новостных сводок из различных источников (NYTimes, Forbes, Benzinga и др.) через Alpha Vantage API.
    *   Структурированное хранение и обработка данных для анализа и обучения моделей.
*   **Анализ и прогнозирование:**
    *   Прогнозирование цен закрытия активов на различные горизонты (например, 8-дневный) с использованием моделей CatBoost.
    *   Анализ тональности новостных сообщений (RoBERTa-base sentiment) для оценки рыночного сентимента.
    *   Суммаризация новостных статей (DistilBERT summarizer).
*   **Оптимизация и ребалансировка портфеля:**
    *   Рекомендации на основе DRL-моделей (A2C, PPO, DDPG, SAC), использующих прогнозы цен, технические индикаторы и новостной сентимент.
    *   Поддержка классических подходов (модель Марковица) в качестве бенчмарка.
    *   Адаптация стратегий к рыночным условиям, включая консервативное поведение (например, перевод активов в стейблкоин USDT).
*   **Взаимодействие с пользователем:**
    *   Интерактивный веб-интерфейс на Streamlit.
    *   Визуализация данных, результатов анализа, прогнозов и рекомендаций.
    *   AI-агент на базе Llama3 для консультаций по рыночной ситуации.
    *   Анализ эффективности портфеля пользователя и бэктестинг гипотетических стратегий.
*   **MLOps и управление моделями:**
    *   Автоматизация обучения и переобучения моделей (ClearML).
    *   Версионирование данных, кода, моделей и экспериментов.
    *   Развертывание (сервинг) обученных моделей для использования в реальном времени.

## 3. Архитектура системы

<!-- IDEAS FOR VISUALS: Здесь отлично будет смотреться общая компонентная схема архитектуры системы (Рис. 1 из ВКР) -->
Система имеет многокомпонентную архитектуру, ориентированную на модульность и масштабируемость:

*   **Уровень представления (Frontend):** Streamlit – пользовательский веб-интерфейс.
*   **Уровень приложений (Backend):**
    *   FastAPI: Основной асинхронный сервер приложений (API, бизнес-логика).
    *   Celery Workers: Распределенная система асинхронных задач для ресурсоемких операций (сбор данных, ML-инференс, бэктесты).
    *   Message Broker (RabbitMQ/Redis): Очередь сообщений для Celery.
*   **Уровень данных:**
    *   PostgreSQL: Хранение структурированной информации (пользователи, портфели, транзакции).
    *   Redis: Кэширование, бэкенд для Celery.
    *   S3-совместимое хранилище: Хранение больших объемов данных (сырые и обработанные рыночные/новостные данные, ML-артефакты, конфигурации Hydra).
*   **Уровень ML-инфраструктуры и MLOps (ClearML Platform):**
    *   ClearML Experiment Tracking: Отслеживание экспериментов.
    *   ClearML Data: Версионирование данных.
    *   ClearML Model Registry: Реестр версионированных моделей.
    *   ClearML Pipelines & Scheduler: Оркестрация и запуск пайплайнов.
    *   ClearML Agents: Исполнители задач.
    *   ClearML Serving: Развертывание моделей (CatBoost, DRL, NLP, LLM), интеграция с NVIDIA Triton Inference Server.
*   **Внешние сервисы:** Binance API (рыночные данные), Alpha Vantage API (новости).
*   **Управление конфигурациями:** Hydra.

### Технологический стек

*   **Frontend:** Streamlit
*   **Backend:** FastAPI, Celery
*   **Базы данных:** PostgreSQL, Redis
*   **Хранилище объектов:** S3-совместимое (например, MinIO)
*   **MLOps:** ClearML
*   **ML Библиотеки:** PyTorch, TensorFlow, Scikit-learn, CatBoost, Stable Baselines3, FinRL, Transformers, ta
*   **Контейнеризация:** Docker, Docker Compose
*   **Язык программирования:** Python

### 4.1. Сбор и хранение данных

<!-- IDEAS FOR VISUALS: Можно добавить упрощенную схему потоков данных при сборе (Рис. 15 из ВКР) -->
*   **Источники:** Binance API (рыночные данные OHLCV), Alpha Vantage API (финансовые новости).
*   **Хранение:**
    *   S3: Сырые и обработанные рыночные/новостные данные (CSV), ML-артефакты, конфигурации Hydra (версионирование через ClearML Data).
    *   PostgreSQL: Метаданные, агрегированная информация, данные пользователей.
*   **Автоматизация:** Обновление данных через ClearML Pipelines (data_ingestion_binance_pipeline, news_ingestion_alphavantage_pipeline).

### 4.2. Анализ и прогнозирование

<!-- IDEAS FOR VISUALS: Пример графика прогноза цен CatBoost (Рис. 20) или важности признаков (Табл. 4) -->
*   **Прогнозирование цен активов:**
    *   Модель: CatBoost.
    *   Признаки: Лаговые значения, технические индикаторы, календарные признаки, новостной сентимент.
    *   Горизонт: Экспериментально подобранный (например, 8 дней для BTC).
*   **Анализ новостного фона:**
    *   Суммаризация: DistilBERT (например, sshleifer/distilbart-cnn-12-6).
    *   Анализ тональности: RoBERTa-sentiment (например, siebert/sentiment-roberta-large-english).
*   **AI-агент (FinRobot):**
    *   Модель: Llama3-8b.
    *   Функционал: Интерактивные консультации по рынку, интерпретация данных.
    *   Развертывание: ClearML Serving с NVIDIA Triton.

### 4.3. Оптимизация и ребалансировка портфеля

<!-- IDEAS FOR VISUALS: График сравнения доходности DRL-моделей (Рис. 19 или Рис. 22) или пример распределения активов (Рис. 23) -->
*   **DRL-агенты:**
    *   Алгоритмы: A2C, PPO, DDPG, SAC (реализация через FinRL, Stable Baselines3).
    *   Состояние (State Space): Исторические рыночные данные, технические индикаторы, ковариационная матрица, текущие веса, прогнозы цен CatBoost, новостной сентимент.
    *   Действие (Action Space): Целевые веса активов (включая USDT).
    *   Вознаграждение (Reward Function): Комбинация доходности, коэффициента Шарпа, штрафов за волатильность/просадки, транзакционные издержки.
*   **Интеграция прогнозов:** Использование предсказаний цен от CatBoost и новостного сентимента в DRL-агентах.
*   **Альтернативные стратегии:** Модель Марковица, "Buy & Hold", "Equal Weight" для сравнения.
*   **Консервативное поведение:** Возможность перевода активов в USDT при негативной рыночной динамике.

## 5. MLOps конвейер с ClearML

<!-- IDEAS FOR VISUALS: Схема пайплайна обучения моделей (Рис. 16 из ВКР) или общая схема MLOps -->
*   **Управление данными:**
    *   Автоматизированные пайплайны (ClearML Pipelines) для сбора, обработки и версионирования рыночных (Binance) и новостных (Alpha Vantage) данных.
    *   Использование ClearML Data для версионирования датасетов в S3.
*   **Обучение моделей:**
    *   Автоматизированные пайплайны для обучения моделей прогнозирования цен (CatBoost) и DRL-ребалансировщиков.
    *   Логирование экспериментов, метрик, артефактов в ClearML Experiment Tracking.
    *   Оценка моделей и сравнение с предыдущими версиями.
    *   Регистрация лучших моделей в ClearML Model Registry.
*   **Сервинг моделей:**
    *   Развертывание зарегистрированных моделей (CatBoost, DRL, NLP, LLM) как API-эндпоинтов через ClearML Serving.
    *   Интеграция с NVIDIA Triton Inference Server для оптимизации инференса LLM.
    *   Обращение FastAPI бэкенда и Celery воркеров к этим эндпоинтам.
*   **Управление конфигурациями:** Hydra для гибкости и воспроизводимости.

## 6. Ключевые сценарии использования

1.  **Получение рекомендаций по ребалансировке портфеля:**
    *   Пользователь выбирает DRL-модель.
    *   FastAPI инициирует асинхронную Celery-задачу.
    *   Celery worker собирает признаки, запрашивает прогнозы (CatBoost на ClearML Serving), получает рекомендацию от DRL-модели (на ClearML Serving) и сохраняет результат.
    *   Streamlit отображает рекомендации.
2.  **Анализ новостей по активу с использованием AI-Агента:**
    *   Пользователь выбирает актив.
    *   Celery-задача загружает новости, анализирует тональность (RoBERTa на ClearML Serving), взаимодействует с LLM (Llama3 на ClearML Serving) для генерации сводки.
    *   Streamlit отображает анализ и интерфейс чата с AI-агентом.
3.  **Анализ эффективности портфеля / Бэктестинг:**
    *   Пользователь задает параметры для реального или гипотетического портфеля.
    *   Celery-задача выполняет бэктест для различных стратегий (DRL, Марковиц, Buy&Hold), взаимодействуя с ML-моделями на ClearML Serving.
    *   Рассчитываются метрики производительности (доходность, Шарп, просадка).
    *   Streamlit визуализирует результаты.

## 7. Результаты экспериментов (Основные моменты)

*   **Прогнозирование цен (CatBoost):**
    *   Оптимальный горизонт для BTC определен в районе 8 дней, где CatBoost показал улучшение MAPE на ~18-30% по сравнению с наивным прогнозом.
    *   Walk-Forward бэктест с ежечасным переобучением подтвердил способность модели превосходить наивный прогноз.
    *   Важные признаки: среднемесячная целевая цена, недавние лаги цен, новостной сентимент.
*   **DRL-ребалансировщики:**
    *   Интеграция прогнозов CatBoost улучшила общую доходность, коэффициент Шарпа и снизила максимальную просадку DRL-агентов (SAC, PPO, DDPG, A2C).
    *   Модель SAC + CatBoost показала прирост доходности +8.00 п.п. и снижение просадки на ~4.6 п.п. по сравнению с базовой SAC.
    *   DRL-модели (особенно SAC) продемонстрировали лучшие результаты (меньшие убытки или большую прибыль в зависимости от периода) и более консервативное поведение по сравнению со стратегией Марковица на тестовых периодах.
*   **NLP-модули:** DistilBERT эффективно суммаризирует новости, RoBERTa-sentiment предоставляет количественную оценку тональности, Llama3 демонстрирует осмысленность диалога.

## 8. Инфраструктурные аспекты

*   **Производительность:** FastAPI и Celery обеспечивают асинхронную обработку запросов. ClearML Serving позволяет масштабировать ML-инференс.
*   **Масштабируемость:** Горизонтальное масштабирование Celery воркеров, FastAPI инстансов и реплик моделей на ClearML Serving.
*   **Мониторинг:** Планируется интеграция с Prometheus и Grafana для сбора и визуализации метрик системы. ClearML предоставляет встроенный мониторинг ML-компонентов.
*   **Автоматизация:** Полная автоматизация MLOps-цикла (данные, обучение, деплой) через ClearML.

## 9. Направления дальнейшего развития

*   **Улучшение AI-агента (FinRobot):** Персонализация (риск-профиль), доступ к онлайн-информации, углубленный анализ риска, формирование сложных стратегий, оптимизация инференса LLM.
*   **Расширение модельного ряда:** Исследование альтернативных моделей ребалансировки (классические ML, эконометрические), мультиагентные системы.
*   **Улучшение инфраструктуры и UX:** Более гранулярный контроль для пользователя, система уведомлений, повышение отказоустойчивости.

---

*Для детальной информации по каждому модулю, теоретическим основам и результатам экспериментов см. полный текст выпускной квалификационной работы.*

*Для запуска и развертывания проекта см. также соответствующие инструкции по настройке Docker, ClearML и переменных окружения. Детали конфигурации сервисов находятся в `docker-compose.yml`.*
